<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Database</title>
  <link rel="icon" href="https://i.ibb.co/dWV6wgj/skyrocket-128.jpg" sizes="32x32">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    th, td { text-align: center; }
  </style>
</head>
<body style="width: 80%; padding: 2%; background-color: rgba(32,33,36);">
  <h1 style="color: aliceblue;">Database</h1>

  <label for="filter" style="color: aliceblue;"><b><h4>Filter by ID:</h4></b></label>
  <input class="col-2" type="number" id="filter" placeholder="Enter ID 0-6" min="0" max="6">

  <table class="table table-striped table-dark" id="table">
    <thead id="trbody"></thead>
    <tbody id="dataTableBody"></tbody>
  </table>

  <script>
    const tableHead = document.getElementById('trbody');
    const tableBody = document.getElementById('dataTableBody');
    let filter_id = null;

    document.getElementById('filter').addEventListener('input', function () {
      const val = this.value;
      const valNum = Number(val);
      if (val === '' || (valNum >= 0 && valNum <= 6)) {
        filter_id = valNum;
        if (val !== '') {
          console.log(`Fetching data for filter ID: ${valNum}`);
          fetchAndDisplay(valNum);
        } else {
          tableHead.innerHTML = '';
          tableBody.innerHTML = '';
          console.log('Input cleared â€“ table reset.');
        }
      } else {
        alert("There is no such table, enter a number between 0-6");
        console.warn("Invalid filter ID entered:", val);
        this.value = "";
      }
    });

    const fetchAndDisplay = (filterid) => {
      tableHead.innerHTML = '';
      tableBody.innerHTML = '';

      const headerRow = document.createElement('tr');
      headersMap[filterid].forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      tableHead.appendChild(headerRow);

      fetch('/all_tables')
        .then(response => {
          if (!response.ok) throw new Error("Failed to fetch tables");
          return response.json();
        })
        .then(data => {
          console.log("Data received from server:", data);
          displayRecords(data, filterid);
        })
        .catch(error => {
          console.error("Error fetching records:", error);
          alert("Error fetching data. Check the console for details.");
        });
    };

    const displayRecords = (records, filterid) => {
      const funcs = [appendRow0, appendRow1, appendRow2, appendRow3, appendRow4, appendRow5, appendRow6];
      if (!records || !Array.isArray(records[filterid])) {
        console.error("No valid records found for filterid:", filterid);
        return;
      }
      console.log(`Displaying ${records[filterid].length} records for table ${filterid}`);
      records[filterid].forEach(record => {
        try {
          funcs[filterid](record);
        } catch (err) {
          console.error("Error rendering row:", err, record);
        }
      });
    };

    const headersMap = {
      0: ['TABLE', 'ID', 'USERNAME', 'PASSWORD', 'EMAIL', 'ROLE_NAME (JOIN)'],
      1: ['TABLE', 'ID', 'NAME', 'COUNTRY_ID', 'CONTINENT (JOIN)'],
      2: ['TABLE', 'ID', 'NAME', 'CONTINENT_ID', 'USER_ID', 'COUNTRY_NAME', 'USER_NAME'],
      3: ['TABLE', 'ID', 'FIRST_NAME', 'LAST_NAME', 'ADDRESS', 'PHONE_NO', 'CREDIT_CARD_NO', 'USER_ID', 'USER_NAME'],
      4: ['TABLE', 'ID', 'AIRLINE_ID', 'ORIGIN_COUNTRY_ID', 'DESTINATION_COUNTRY_ID', 'DEPARTURE_TIME', 'LANDING_TIME', 'REMAINING_TICKETS', 'AIRLINE_NAME', 'ORIGIN_COUNTRY_NAME', 'DESTINATION_COUNTRY_NAME'],
      5: ['TABLE', 'ID', 'FLIGHT_ID', 'PASSENGER_ID', 'CUSTOMER_ID', 'AIRLINE_NAME', 'FLIGHT_DESTINATION', 'PASSENGER_FIRST_NAME', 'PASSENGER_LAST_NAME', 'SEAT', 'USER_NAME'],
      6: ['TABLE', 'ID', 'FIRST_NAME', 'LAST_NAME', 'DATE_OF_BIRTH', 'PASSPORT_NUMBER']
    };

    const name = {
      0: 'USERS', 1: 'COUNTRIES', 2: 'AIRLINES',
      3: 'CUSTOMERS', 4: 'FLIGHTS', 5: 'TICKETS', 6: 'PASSENGERS'
    };

    const createCell = (text) => {
      const td = document.createElement('td');
      td.textContent = text !== undefined && text !== null ? text : 'N/A';
      return td;
    };

    const appendRow = (values) => {
      const tr = document.createElement('tr');
      values.forEach(value => tr.appendChild(createCell(value)));
      tableBody.appendChild(tr);
    };

    const appendRow0 = r => appendRow([`0-${name[0]}`, r.id, r.username, r.password, r.email, r.role_name]);
    const appendRow1 = r => appendRow([`1-${name[1]}`, r.id, r.country_name, r.continent_id, r.continent]);
    const appendRow2 = r => appendRow([`2-${name[2]}`, r.id, r.name, r.country_id, r.user_id, r.country_name, r.user_name]);
    const appendRow3 = r => appendRow([`3-${name[3]}`, r.id, r.first_name, r.last_name, r.address, r.phone, r.credit_card, r.user_id, r.user_name]);
    const appendRow4 = r => appendRow([`4-${name[4]}`, r.id, r.airline_id, r.origin_country_id, r.destination_country_id, r.departure_time, r.landing_time, r.remaining_tickets, r.airline_name, r.origin_country_name, r.destination_country_name]);
    const appendRow5 = r => appendRow([`5-${name[5]}`, r.id, r.flight_id, r.passenger_id, r.customer_id, r.airline_name, r.flight_destination, r.passanger_first_name, r.passanger_last_name, r.seat, `${r.first_name} ${r.last_name}`]);
    const appendRow6 = r => appendRow([`6-${name[6]}`, r.id, r.first_name, r.last_name, r.date_of_birth, r.passport_number]);
  </script>
</body>
</html>
