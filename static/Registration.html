<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
<style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Varela Round', sans-serif;
        background-image: url("plane.jpg");
        background-repeat: no-repeat;
        background-size: 99.9% 99.9%;
        background-position: center;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }

    .signup-form {
        background-color: #cbe3f5c1;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
    }

    h1 {
        text-align: center;
    }

    input {
        font-family: 'Varela Round', sans-serif;

        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        /* Makes sure padding does not affect overall width */
    }

    /* Mark input boxes that gets an error on validation: */
    input.invalid {
        background-color: #ffdddd;
    }

    /* Hide all steps by default: */
    .tab {
        display: none;
    }

    .nextBtn {
        padding: 10px;
        border: none;
        border-radius: 4px;
        background-color: #b0b6bd;
        color: white;
        cursor: pointer;
        font-size: 16px;
    }

    .nextBtn:hover {
        background-color: rgb(222, 0, 45);
        ;
    }

    .backBtn,
    .nextBtn2 {
        padding: 10px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        font-size: 16px;
    }

    .backBtn,
    .nextBtn2:hover {
        background-color: #0056b3;
    }





    /* Make circles that indicate the steps of the form: */
    .step {
        height: 15px;
        width: 15px;
        margin: 0 2px;
        background-color: #bbbbbb;
        border: none;
        border-radius: 50%;
        display: inline-block;
        opacity: 0.5;
    }

    .step.active {
        opacity: 1;
    }

    /* Mark the steps that are finished and valid: */
    .step.finish {
        background-color: #04AA6D;
    }

    .button-container {
        overflow: auto;
        position: relative;
        padding: 10px;
    }

    #backBtn {
        float: left;
    }

    #nextBtn {
        float: right;
    }

    .form-group img {
        width: 35px;
        cursor: pointer;
    }

    div:disabled,
    button:disabled,
    input:disabled {
        cursor: not-allowed;
    }

    /* לעצב אלמנטים שנראים כמו disabled div אך אין להם מאפיין disabled */
    .disabled {
        cursor: not-allowed;
        pointer-events: none;
        /* לבטל אינטראקציה */
        opacity: 0.6;
        /* אופציונלי: להראות שהאלמנט מנוטרל */
    }

    .green-text {
        color: rgb(54, 113, 84);
    }

    .green-v {
        color: rgb(60, 120, 85);
        font-size: 16px;
    }

    .red-x {
        color: rgb(222, 0, 45);
        font-size: 20px;

    }

    .red-text {
        color: rgb(222, 0, 45);
    }

    .reduced-line-height p {
        line-height: 6px;
        /* Adjust this value to change the line spacing in pixels */
    }

    .card-input-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }
        .card-input {
            flex: 1;
            padding-right: 140px; /* Adjust according to the size of the added fields */
        }
        .extra-inputs {
            position: absolute;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .extra-inputs input {
            width: 50px; /* Adjust width as needed */
            text-align: center;
        }
</style>

<body>

    <form class="signup-form" id="login-form">
        <h1>Register:</h1>
        <!-- One "tab" for each step in the form: -->
        <div class="tab">user information:
            <div class="form-group">
                <p><input type="text" placeholder="First name..." oninput="this.className = ''" name="fname"
                        maxlength="30" pattern="[a-z]{1,30}" title="Please enter up to 30 lowercase letters"></p>
                <p><input type="text" placeholder="Last name..." oninput="this.className = ''" name="lname"
                        maxlength="30" pattern="[a-z]{1,30}" title="Please enter up to 30 lowercase letters"></p>
                <p><input type="email" placeholder="example@example.com" oninput="validateEmail(this)"
                        onkeypress="return /^[a-z0-9._-@]+$/.test(event.key)" name="email" id="email"></p>
                <p style="display: none;" id="email_error"><b class="red-x">&#10006;</b>
                    <spam class="red-text">Invalid email. Please enter a valid email.</spam>
                </p>
                <p style="display: none;" id="email_"><b class="green-v">&#10004;</b>
                    <spam class="green-text">valid email.</spam>
                </p>
                <div class="form-group" id="pass" style="display: block">
                    <label for="password" style="font-family: 'Varela Round', sans-serif;">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="password" placeholder="example: Aa12345@" name="password"
                            style="display: block;" oninput="validatePassword(this)" pattern="^[^#%&+]+$"
                            onkeypress="if(this.value.length >= 9 || event.key.match(/[^\x00-\x7F]/) || event.key === '#' || event.key === '%' || event.key === '&' || event.key === '+' || event.key === '\\' || event.key === '/'  || event.key === ',' || event.key === '`'|| event.key === '`' || event.key === '.'|| event.key === '[' || event.key === ']' || event.key === '{' || event.key === '}' || event.key === '<' || event.key === '>') return false;"
                            aria-checked="false" disabled>

                        <img src="/eye.gif" alt="" id="eyeicon"
                            style="font-family: 'Varela Round', sans-serif;position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
                    </div>

                    </br>
                    <div style="position: relative;">
                        <label for="password" style="font-family: 'Varela Round', sans-serif;">Confirm Password</label>
                        <div style="position: relative;">
                            <input type="password" id="password2" placeholder="example: Aa12345@" name="password"
                                oninput="Checking_passwords(this)"
                                onkeypress="if(this.value.length >= 9 || event.key.match(/[^\x00-\x7F]/)) return false;"
                                onpaste="return false;" aria-checked="false" disabled>
                            <img src="/eye.gif" alt="" id="eyeicon2"
                                style="font-family: 'Varela Round', sans-serif;position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
                        </div>
                    </div>

                    <div class="reduced-line-height">
                        <p style="color: rgb(222, 0, 45); display: none; font-family: 'Varela Round', sans-serif;"
                            id="password_error">Must: 8
                            characters-[A-Z]-[a-z]/[0-9]-[!/@/$/?/*]</p>
                        <p style="display: none;" id="password_"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab">Contact Info:

            <p><input type="text" placeholder="Phone..." pattern="05\d{8}"
                    title="Please enter a valid phone number starting with '05'" maxlength="10"
                    oninput="validatePhone(this)" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                    name="phone"></p>
            <p style="color: red; display: none;" id="phone_error">Invalid phone. Please enter a valid phone number.</p>
            <p style="color: green; display: none;" id="phone_">valid ID number.</p>

            <p><input type="text" placeholder="ID Number..." name="id_number" oninput="validateIdNumber(this)"
                    onkeypress="return event.charCode >= 48 && event.charCode <= 57" pattern="[0-9]{9}" minlength="9"
                    maxlength="9"></p>
            <p style="color: red; display: none;" id="id_number_error">Invalid ID number. Please enter a valid ID
                number.</p>
            <p style="color: green; display: none;" id="id_number">valid ID number.</p>
            <div class="card-input-wrapper">
                <input type="text" class="card-input" placeholder="Credit Card Number..."
                       pattern="\d{16}" maxlength="16" minlength="16" name="credit_card"
                       onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                    <div class="extra-inputs">
                        <input type="text" id="expiry_date" name="expiry_date" placeholder="MMYY" 
                               pattern="\d{4}" maxlength="4" minlength="4" required
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                        <input type="text" id="cvv" name="cvv" placeholder="CVV" 
                               pattern="\d{3}" maxlength="3" minlength="3" required
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                    </div>
            <p style="color: red; display: none;" id="card_error">Invalid ID number. Please enter a valid ID number.</p>
            <p style="color: green; display: none;" id="card_">valid ID number.</p>
            </div>
            <label for="birthday">Birthday:</label>
            <input type="date" id="birthday" name="birthday">


        </div>

        <div class="tab">:
            <p>Congratulations on your decision to register on our flights website! Becoming a registered user will
                enable you to enjoy a wide range of benefits.</p>
            <p>Not only will you be able to discover lucrative deals and exclusive offers, but you'll also receive
                notifications about fluctuating flight prices, view flight statuses, and compare different options to
                find the best one for you.</p>
            <p>Additionally, as a member of our community, you'll receive personalized advice from our experts, share
                experiences, and participate in engaging discussions and competitions.</p>
            <p>And that's not all! Every time you book your flights through the website, you'll accumulate points and
                perks that will make your travel experience even more enjoyable.</p>
            <p>So, what are you waiting for? Join now and start enjoying the amazing benefits of being a registered user
                on our flights website!</p>
        </div>


        <div class="button-container">
            <button type="button" class="backBtn" id="backBtn" onclick="nextPrev(-1)">Back</button>
            <button type="button" class="nextBtn" id="nextBtn" onclick="nextPrev(1)" disabled>Next</button>
        </div>
        </div>
        <!-- Circles which indicates the steps of the form: -->
        <div style="text-align:center;margin-top:40px;">
            <span class="step"></span>

            <span class="step"></span>
        </div>
    </form>

    <script>
        let eyeicon = document.getElementById("eyeicon");
        let eyeicon2 = document.getElementById("eyeicon2");

        let password = document.getElementById("password");
        let password2 = document.getElementById("password2");


        eyeicon.addEventListener("click", () => {
            if (password.type == "password") {
                password.type = "text";
                password2.type = "text";
                eyeicon.src = "/eye.png";
                eyeicon2.src = "/eye.png";


            } else {
                password.type = "password";
                password2.type = "password";
                eyeicon.src = "/eye.gif";
                eyeicon2.src = "/eye.gif";


            }
        })
        var currentTab = 0; // Current tab is set to be the first tab (0)
        showTab(currentTab); // Display the current tab

        function showTab(n) {

            document.getElementById("nextBtn").disabled = true
            document.getElementById('nextBtn').className = 'nextBtn';
            // This function will display the specified tab of the form...
            var x = document.getElementsByClassName("tab");
            x[n].style.display = "block";
            //... and fix the Back/Next buttons:
            if (n == 0) {
                document.getElementById("backBtn").style.display = "none";
            } else {
                document.getElementById("backBtn").style.display = "inline";
            }
            if (n == (x.length - 1)) {
                document.getElementById("nextBtn").innerHTML = "finish";
            } else {
                document.getElementById("nextBtn").innerHTML = "Next";
            }
            //... and run a function that will display the correct step indicator:
            fixStepIndicator(n)
        }

        function nextPrev(n) {
            // This function will figure out which tab to display
            var x = document.getElementsByClassName("tab");
            // Exit the function if any field in the current tab is invalid:
            if (n == 1 && !validateForm()) return false;
            // Hide the current tab:
            x[currentTab].style.display = "none";
            // Increase or decrease the current tab by 1:
            currentTab = currentTab + n;
            // if you have reached the end of the form...
            if (currentTab >= x.length) {
                // ... the form gets submitted:
                const submitButton = document.getElementById('nextBtn');

                submitButton.textContent = 'connect';
                submitButton.removeAttribute('onclick');
                submitButton.addEventListener('click', Registration);
                document.getElementById('nextBtn').className = 'nextBtn2';
            }
            // Otherwise, display the correct tab:
            showTab(currentTab);
        }
     async   function Registration() {
            event.preventDefault(); // עצירת ההתנהגות הרגילה של הטופס
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/role_users/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();

                handleResponse(data);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function handleResponse(data) {
            console.log("data.err", data.err);
            console.log("data loginUrl", data.loginUrl);

            const successMessage = document.getElementById('success-message');
            if (data.err === "yes") {
                successMessage.textContent = data.error;
                window.location.href = data.loginUrl;
            } else if (data.loginUrl) {
                successMessage.textContent = 'Signup successful!';
                window.location.href = data.loginUrl;
            }
        }
        function validateForm() {
            // This function deals with validation of the form fields
            var x, y, i, valid = true;
            x = document.getElementsByClassName("tab");
            y = x[currentTab].getElementsByTagName("input");
            // A loop that checks every input field in the current tab:
            for (i = 0; i < y.length; i++) {
                // If a field is empty...
                if (y[i].value == "") {
                    // add an "invalid" class to the field:
                    y[i].className += " invalid";
                    // and set the current valid status to false
                    valid = false;
                }
            }
            // If the valid status is true, mark the step as finished and valid:
            if (valid) {
                document.getElementsByClassName("step")[currentTab].className += " finish";
            }
            return valid; // return the valid status
        }

        function fixStepIndicator(n) {
            // This function removes the "active" class of all steps...
            var i, x = document.getElementsByClassName("step");
            for (i = 0; i < x.length; i++) {
                x[i].className = x[i].className.replace(" active", "");
            }
            //... and adds the "active" class on the current step:
            x[n].className += " active";
        } function validateIdNumber(input) {
            let idNumber = input.value.trim();

            if (isValidIdNumber(idNumber)) {
                input.className = '';
            } else {
                input.className = 'error';
            }
        }
        // Function to check if the ID number is valid
        function checkIdNumber(inputNumber) {
            let isValid;
            let numSum = 0;

            try {
                // Validate inputNumber length
                if (inputNumber.length !== 9) {
                    throw "Input number must be 9 digits long";
                }

                // Calculate the sum according to the algorithm
                for (let i = 0; i < 9; i++) {
                    let digit = parseInt(inputNumber.charAt(i));
                    let factor = (i % 2 === 0) ? 1 : 2;
                    let product = digit * factor;
                    // Add digits of products over 9
                    numSum += (product > 9) ? product - 9 : product;
                }

                // Check if the sum is divisible by 10
                isValid = (numSum % 10 === 0);
            } catch (error) {
                // If any error occurs, consider the ID invalid
                isValid = false;
                console.error("Error:", error);
            }
            return isValid;
        }



        // פונקציה שמתבצעת כאשר מתבצעת הקלטה בשדה
        function validateIdNumber(input) {
            // קבלת הערך של ה-ID number מהשדה
            let inputNumber = input.value.trim();

            // בדיקה האם הערך תקין
            if (/^\d{9}$/.test(inputNumber)) {
                // התראה על תוקף המספר
                if (checkIdNumber(inputNumber)) {
                    input.className = '';
                    document.getElementById("id_number_error").style.display = "none";
                    document.getElementById("id_number").style.display = "block";
                } else {
                    input.className = 'invalid';
                    document.getElementById("id_number_error").style.display = "block";
                    document.getElementById("phone_").style.display = "none";
                }
            } else {
                input.className = 'invalid';
                // התראה על אורך לא תקין או תווים לא תקינים
                document.getElementById("id_number_error").style.display = "block";
                document.getElementById("phone_").style.display = "none";
            }
        }
        // הוספת אירוע 'change' לשדה ה-ID number
        document.getElementsByName("id_number")[0].addEventListener("change", validateIdNumber);

        function validatePhone(input) {
            const phone = input.value.trim();
            const phoneRegex = /^05\d{8}$/;
            if (phoneRegex.test(phone)) {
                input.className = '';
                document.getElementById("phone_").style.display = "block";
                document.getElementById("phone_error").style.display = "none";


            } else {
                input.className = 'invalid';
                document.getElementById("phone_error").style.display = "block";
                document.getElementById("phone_").style.display = "none";


            }
        }
        function validateEmail(input) {
            const email = input.value.trim();
            const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;
            if (emailRegex.test(email)) {
                input.className = '';
                document.getElementById("email_").style.display = "block";
                document.getElementById("email_error").style.display = "none";
                document.getElementById("password").disabled = false;
                document.getElementById("password_error").style.display = "block";


            } else {
                input.className = 'invalid';
                document.getElementById("password").disabled = true;
                document.getElementById("email_error").style.display = "block";
                document.getElementById("email_").style.display = "none";
            }
        }

        function validatePassword(input) {
            document.getElementById("email_").style.display = "none";
            const password = input.value.trim();
            const lengthRegex = /^.{8,}$/;
            const LowerCase = /[a-z]/;
            const uppercaseRegex = /[A-Z]/;
            const Numbers = /[0-9]/
            const specialCharRegex = /[~!@$^*?=_-]/;
            const forbidden_characters = /["|'()]/;
            // התבנית הבאה מייחסת רק לתווים באנגלית
            const englishOnlyRegex = /^[a-zA-Z0-9@$!%*?&]*$/;
            let errorMessage = "";
            let successMessage = "";
            document.getElementById("email").disabled = true;

            const check = (regex, message) => {
                if (!regex.test(password)) errorMessage += `<p><b class="red-x">&#10006;</b> <spam class ="red-text">${message}</spam></P>`;
                else successMessage += `<p><b class="green-v">&#10004;</b> <spam class ="green-text">${message}</spam></P>`;
            };
            const check2 = (regex, message) => {
                if (regex.test(password)) errorMessage += `<p><b class="red-x">&#10006;</b> <span class="red-text">${message}</span></p>`;
                else successMessage += `<p><b class="green-v">&#10004;</b> <spam class ="green-text">${message}</spam></P>`;
            };

            check(lengthRegex, "At least 8 characters");
            check(LowerCase, "LowerCase letters (a-z)");
            check(uppercaseRegex, "Upper case letters (A-Z)");
            check(Numbers, "Numbers (0-9)");
            check(specialCharRegex, "Special characters [~!@$^*?=_-]");
            check2(forbidden_characters, `Forbidden characters [ " ' ()]`);

            // הוסף את הבדיקה של התבנית הרגולרית של התווים באנגלית

            input.classList.toggle('invalid', errorMessage !== "");
            document.getElementById("password_error").innerHTML = errorMessage;
            document.getElementById("password_error").style.display = errorMessage ? "block" : "none";
            document.getElementById("password_").innerHTML = successMessage;
            document.getElementById("password_").style.display = successMessage ? "block" : "none";
            document.getElementById("password2").disabled = errorMessage ? true : false


        }


        function Checking_passwords() {


            const password = document.getElementById('password').value;
            const password2 = document.getElementById('password2').value;

            if (password === password2) {

                document.getElementById("password_").innerHTML = `<p><b class="green-v">&#10004;</b>
                <spam class="green-text">The passwords are the same</spam></p>`;
                document.getElementById("password_error").style.display = "block" ? "none" : "none";
                document.getElementById("password_").style.display = "none" ? "block" : "none";
                document.getElementById("nextBtn").disabled = false
                document.getElementById('nextBtn').className = 'nextBtn2';




            } else {
                document.getElementById("nextBtn").disabled = true
                document.getElementById('nextBtn').className = 'nextBtn';
                document.getElementById("password_error").innerHTML = `<p><b class="red-x">&#10006;;</b>
                <spam class="red-text">The passwords are not the same</spam></p>`;
                document.getElementById("password_error").style.display = "none" ? "block" : "none";
                document.getElementById("password_").style.display = "block" ? "none" : "none";
            }

        }
        function checkCreditCardValidity(input) {
            let CardNumber = input.value.trim();

            let isValid;
            let totalSum = 0;
            let isSecond = false;

            // Remove any spaces from the credit card number
            CardNumber = CardNumber.replace(/\s/g, '');

            if (CardNumber.length !== 16) {
                isValid = false
            }
            else {

                if (!/\D/.test(CardNumber)) {
                    for (let i = CardNumber.length - 1; i >= 0; i--) {
                        let digit = parseInt(CardNumber.charAt(i));

                        if (isSecond) {
                            digit *= 2;
                            if (digit > 9) {
                                digit -= 9;
                            }
                        }

                        totalSum += digit;
                        isSecond = !isSecond;
                    }

                    if (totalSum % 10 === 0) {
                        isValid = true;
                    }
                }

            }
            if (isValid) {
                input.className = '';

                document.getElementById("card_").style.display = "block";
                document.getElementById("card_error").style.display = "none";
            } else {
                input.className = 'invalid';

                document.getElementById("card_error").style.display = "block";
                document.getElementById("card_").style.display = "none";


            }
        }
    </script>

</body>

</html>